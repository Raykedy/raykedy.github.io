<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Скачать книгу за криптодонат — 2051</title>
<meta name="color-scheme" content="dark"/>
<style>
  :root{
    --bg:#0c0f14; --panel:#121722; --text:#e8ecf3; --muted:#9aa2b1; --stroke:rgba(255,255,255,.12);
    --pill1:#a0522d; /* "Скачать книгу за донат" */
    --pill2:#006400; /* "3.99 USDT" */
    --sel:#1b2738;   /* активный формат */
  }
  *{box-sizing:border-box}
  body{
    margin:0; background:var(--bg); color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; line-height:1.55; text-align:center;
  }
  .wrap{max-width:720px; margin:0 auto; padding:28px 14px 60px}
  h1{margin:0 0 10px; font-size:clamp(22px,3.4vw,32px)}
  .muted{color:var(--muted)}
  .panel{background:#101622; border:1px solid var(--stroke); border-radius:14px; padding:20px; margin:16px 0}

  /* кнопки */
  .pill-stack{display:grid; gap:14px; margin:0 auto; max-width:420px}
  .pill-btn{
    padding:16px 20px; border-radius:24px; border:1px solid var(--stroke);
    font-weight:700; font-size:18px; color:#fff; cursor:pointer;
  }
  .pill-primary{background:var(--pill1); border-color:var(--pill1)}
  .pill-price{background:var(--pill2); border-color:var(--pill2)}

  /* e-mail */
  .email-wrap{max-width:420px; margin:14px auto 0; display:grid; gap:10px}
  .email-input{
    padding:14px 16px; border-radius:16px; border:1px solid var(--stroke);
    background:#0f1420; color:#e8ecf3; font-size:16px; text-align:center;
  }
  .email-help{font-size:13px; color:#9aa2b1}

  /* выбор формата */
  .format-grid{display:grid; grid-template-columns:repeat(2,1fr); gap:10px; max-width:420px; margin:10px auto 0}
  .format-btn{
    padding:12px 14px; border-radius:16px; border:1px solid var(--stroke);
    background:#0f1420; color:#e8ecf3; cursor:pointer;
  }
  .format-btn[aria-pressed="true"]{background:var(--sel); outline:2px solid rgba(255,255,255,.08)}

  footer{margin-top:30px; color:var(--muted); font-size:13px}
  .link-back{display:inline-block; margin-top:6px; color:#28c76f; text-decoration:none}
</style>
</head>
<body>
  <div class="wrap">
    <h1>Скачать книгу за криптодонат</h1>
    <div class="muted">«2051: Алгоритм Пробуждение»</div>

    <!-- блок с кнопками и e-mail -->
    <div class="panel">
      <div class="pill-stack">
        <button class="pill-btn pill-primary" id="btn-download">Скачать книгу за донат</button>
        <button class="pill-btn pill-price" id="btn-price">3.99 USDT</button>
      </div>
      <div class="email-wrap">
        <input id="buyer-email" class="email-input" type="email" inputmode="email"
               placeholder="Ваш e-mail (сюда придёт ссылка)"/>
        <div class="email-help">
          Все донаты идут на развитие проекта: создание аудиокниги и перевод книги на английский язык.
        </div>
      </div>
    </div>

    <!-- блок выбора формата -->
    <div class="panel">
      <h3 style="margin:0 0 8px">Выберите формат книги</h3>
      <div class="format-grid" role="tablist" aria-label="Формат книги">
        <button class="format-btn" data-format="PDF"  aria-pressed="true">PDF</button>
        <button class="format-btn" data-format="EPUB" aria-pressed="false">EPUB</button>
      </div>
      <div class="email-help" id="format-note" style="margin-top:8px">Вы выбрали: PDF</div>
    </div>

    <footer>
      © 2051: Алгоритм Пробуждение — Ray Kedy
      <br><a class="link-back" href="./index.html">← На главную</a>
    </footer>
  </div>

<script>
  // Быстрый выбор элементов
  const $=(s,r=document)=>r.querySelector(s);
  const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));

  // Проверка e-mail
  function getEmail(){
    const v=($('#buyer-email').value||'').trim();
    const ok=/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v);
    if(!ok){ alert('Введите корректный e-mail'); return ''; }
    localStorage.setItem('buyerEmail', v); // сохраним для удобства
    return v;
  }

  // Выбор формата (PDF/EPUB)
  function getFormat(){
    const a=document.querySelector('.format-btn[aria-pressed="true"]');
    return a ? a.dataset.format : 'PDF';
  }

  // Создание инвойса через API NOWPayments (через воркер)
  async function startInvoice(){
    const email = getEmail(); if(!email) return;
    const format = getFormat();

    const btn = document.getElementById('btn-download');
    const prev = btn.textContent;
    btn.disabled=true;
    btn.textContent='Готовим ссылку…';

    try{
      const res = await fetch('/api/create-invoice', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({
          amount: 3.99,
          currency:'USDT',
          network:'TRC20',
          email,
          format
        })
      });
      const data = await res.json();
      if (data && data.url){
        // открываем платёжную страницу NOWPayments
        window.open(data.url, '_blank');
      } else {
        alert('Не удалось создать ссылку. Проверь подключение.');
      }
    }catch(e){
      alert('Ошибка соединения. Попробуй ещё раз.');
    }finally{
      btn.disabled=false;
      btn.textContent=prev;
    }
  }

  // Навесим обработчики
  document.getElementById('btn-download').addEventListener('click', startInvoice);
  document.getElementById('btn-price').addEventListener('click', startInvoice);

  // Переключение кнопок выбора формата
  $$('.format-btn').forEach(b=>b.addEventListener('click',()=>{
    $$('.format-btn').forEach(x=>x.setAttribute('aria-pressed','false'));
    b.setAttribute('aria-pressed','true');
    const note=document.getElementById('format-note');
    if(note) note.textContent='Вы выбрали: '+b.dataset.format;
  }));
</script>
</body>
</html>
