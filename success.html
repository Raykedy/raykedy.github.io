<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–û–ø–ª–∞—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∞ ‚Ä¢ 2051</title>
  <style>
    :root { --bg:#0b0f14; --card:#111820; --text:#e7eef7; --muted:#9bb0c3; --pri:#22c55e; --pri2:#16a34a; }
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .wrap{min-height:100vh;display:grid;place-items:center;padding:20px}
    .card{width:100%;max-width:560px;background:var(--card);border:1px solid #1b2633;border-radius:16px;padding:24px;box-shadow:0 10px 40px rgba(0,0,0,.35)}
    h1{margin:0 0 8px;font-size:20px}
    p{margin:0 0 10px}
    .muted{color:var(--muted)}
    .row{display:flex;gap:10px;margin-top:12px}
    a.btn,button.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 14px;border-radius:10px;border:0;background:#233142;color:#dbe8f5;text-decoration:none;cursor:pointer}
    a.btn.primary,button.btn.primary{background:var(--pri);color:#09210f}
    a.btn.primary:hover,button.btn.primary:hover{background:var(--pri2)}
    .note{margin-top:10px;color:#9ab; font-size:14px}
  </style>

  <script>
    // –ê–≤—Ç–æ-–ø–æ–∏—Å–∫ –∞–¥—Ä–µ—Å–∞ API –≤–æ—Ä–∫–µ—Ä–∞ (—Ç–∞ –∂–µ –ª–æ–≥–∏–∫–∞)
    (function(){
      const q = new URLSearchParams(location.search);
      const override = q.get('api');
      const candidates = [];
      if (override) candidates.push(override.replace(/\/$/, ''));
      if (window.API_BASE) candidates.push(String(window.API_BASE).replace(/\/$/, ''));
      candidates.push(location.origin);
      candidates.push('https://raykedy.workers.dev');
      candidates.push('https://rk-pay.workers.dev');
      window.API_CANDIDATES = [...new Set(candidates)];
      window.pickApi = async function(){
        for (const base of window.API_CANDIDATES){
          try{
            const r = await fetch(base + '/api/order-status?order=test', { method:'GET' });
            if (r.ok) return base;
          }catch(_){}
        }
        return window.API_CANDIDATES[0];
      }
    })();
  </script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>–°–ø–∞—Å–∏–±–æ! –ü–ª–∞—Ç—ë–∂ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω</h1>
      <p class="muted">–°—Å—ã–ª–∫–∞ –ø—Ä–∏–¥—ë—Ç –Ω–∞ e-mail –∏ –ø–æ—è–≤–∏—Ç—Å—è –Ω–∏–∂–µ. –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è ‚Äî 1 —á–∞—Å.</p>

      <div class="row" style="margin-top:16px">
        <a id="downloadLink" class="btn" href="#" onclick="return false;">üì• –°–∫–∞—á–∞—Ç—å e-–∫–Ω–∏–≥—É</a>
        <button id="resendBtn" class="btn">üîÑ –ü–µ—Ä–µ—Å–ª–∞—Ç—å –ø–∏—Å—å–º–æ</button>
      </div>

      <p class="note">–ï—Å–ª–∏ —Å—Å—ã–ª–∫–∞ –Ω–µ –ø–æ—è–≤–∏–ª–∞—Å—å –≤ —Ç–µ—á–µ–Ω–∏–µ –ø–∞—Ä—ã –º–∏–Ω—É—Ç ‚Äî –Ω–∞–∂–º–∏—Ç–µ ¬´–ü–µ—Ä–µ—Å–ª–∞—Ç—å –ø–∏—Å—å–º–æ¬ª.</p>
    </div>
  </div>

  <script>
    const params = new URLSearchParams(location.search);
    const orderId = params.get('order') || '';

    const downloadLink = document.getElementById('downloadLink');
    const resendBtn = document.getElementById('resendBtn');

    async function poll() {
      try {
        const API_BASE = await window.pickApi();
        const r = await fetch(API_BASE + '/api/order-status?order=' + encodeURIComponent(orderId));
        const d = await r.json();
        if (d.ok && d.link) {
          downloadLink.href = d.link;
          downloadLink.classList.add('primary');
          return; // –≥–æ—Ç–æ–≤–æ
        }
      } catch(e) { console.log(e); }
      setTimeout(poll, 4000);
    }

    resendBtn.addEventListener('click', async ()=>{
      resendBtn.disabled = true;
      try {
        const email = prompt('–£–∫–∞–∂–∏—Ç–µ e-mail, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É:');
        if (!email) { resendBtn.disabled = false; return; }
        const API_BASE = await window.pickApi();
        const r = await fetch(API_BASE + '/api/resend', {
          method: 'POST', headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ orderId, email })
        });
        const d = await r.json();
        alert(d.ok ? '–ü–∏—Å—å–º–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ.' : '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–∏—Å—å–º–æ.');
      } catch (e) {
        alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
      } finally {
        resendBtn.disabled = false;
      }
    });

    if (orderId) poll();
  </script>
</body>
</html>
