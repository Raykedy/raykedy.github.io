<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–û–ø–ª–∞—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∞ ‚Ä¢ 2051</title>
  <style>
    :root { --bg:#0b0f14; --card:#111820; --text:#e7eef7; --muted:#9bb0c3; --pri:#22c55e; --pri2:#16a34a; }
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .wrap{min-height:100vh;display:grid;place-items:center;padding:20px}
    .card{width:100%;max-width:560px;background:var(--card);border:1px solid #1b2633;border-radius:16px;padding:24px;box-shadow:0 10px 40px rgba(0,0,0,.35)}
    h1{margin:0 0 8px;font-size:20px}
    p{margin:0 0 10px}
    .muted{color:var(--muted)}
    .row{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
    a.btn,button.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 14px;border-radius:10px;border:0;background:#233142;color:#dbe8f5;text-decoration:none;cursor:pointer}
    a.btn.primary,button.btn.primary{background:var(--pri);color:#09210f}
    a.btn.primary:hover,button.btn.primary:hover{background:var(--pri2)}
    .note{margin-top:10px;color:#9ab;font-size:14px}
    .err{margin-top:10px;color:#f66}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>–°–ø–∞—Å–∏–±–æ! –ü–ª–∞—Ç—ë–∂ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω</h1>
      <p class="muted">–°—Å—ã–ª–∫–∞ –ø—Ä–∏–¥—ë—Ç –Ω–∞ e-mail –∏ –ø–æ—è–≤–∏—Ç—Å—è –Ω–∏–∂–µ. –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è ‚Äî 1 —á–∞—Å.</p>

      <div class="row" style="margin-top:16px">
        <a id="downloadLink" class="btn" href="#" onclick="return false;">üì• –°–∫–∞—á–∞—Ç—å e-–∫–Ω–∏–≥—É</a>
        <button id="refreshBtn" class="btn">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å—Å—ã–ª–∫—É</button>
        <button id="resendBtn" class="btn">üìß –ü–µ—Ä–µ—Å–ª–∞—Ç—å –ø–∏—Å—å–º–æ</button>
      </div>

      <p class="note">–ï—Å–ª–∏ —Å—Å—ã–ª–∫–∞ –Ω–µ –ø–æ—è–≤–∏–ª–∞—Å—å –≤ —Ç–µ—á–µ–Ω–∏–µ –ø–∞—Ä—ã –º–∏–Ω—É—Ç ‚Äî –Ω–∞–∂–º–∏—Ç–µ ¬´–û–±–Ω–æ–≤–∏—Ç—å —Å—Å—ã–ª–∫—É¬ª –∏–ª–∏ ¬´–ü–µ—Ä–µ—Å–ª–∞—Ç—å –ø–∏—Å—å–º–æ¬ª.</p>
      <div id="err" class="err" hidden></div>
    </div>
  </div>

  <script>
    const params = new URLSearchParams(location.search);
    const orderId = params.get('order') || '';

    const downloadLink = document.getElementById('downloadLink');
    const refreshBtn   = document.getElementById('refreshBtn');
    const resendBtn    = document.getElementById('resendBtn');
    const errBox       = document.getElementById('err');

    function showErr(t){ errBox.textContent=t; errBox.hidden=!t; }

    async function checkOnce(){
      try{
        const r = await fetch(`/api/order-status?order=${encodeURIComponent(orderId)}`);
        const d = await r.json();
        if (d.ok && d.link){
          downloadLink.href = d.link;
          downloadLink.classList.add('primary');
          downloadLink.textContent = 'üì• –°–∫–∞—á–∞—Ç—å e-–∫–Ω–∏–≥—É';
          showErr('');
          return true;
        }
      }catch(e){ showErr('–°–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.'); }
      return false;
    }

    // –ê–≤—Ç–æ-–æ–ø—Ä–æ—Å: –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫ –¥–æ ~5 –º–∏–Ω—É—Ç
    let tries = 0, timer = null;
    async function poll(){
      const ok = await checkOnce();
      if (ok){ clearTimeout(timer); return; }
      if (++tries < 100) timer = setTimeout(poll, 3000);
    }

    refreshBtn.addEventListener('click', async ()=>{
      refreshBtn.disabled = true;
      await checkOnce();
      refreshBtn.disabled = false;
    });

    resendBtn.addEventListener('click', async ()=>{
      resendBtn.disabled = true;
      try{
        const email = prompt('–£–∫–∞–∂–∏—Ç–µ e-mail, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É:');
        if (!email){ resendBtn.disabled = false; return; }
        const r = await fetch('/api/resend', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ orderId, email })
        });
        const d = await r.json();
        alert(d.ok ? '–ü–∏—Å—å–º–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ.' : '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–∏—Å—å–º–æ.');
      }catch(e){ alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.'); }
      finally{ resendBtn.disabled = false; }
    });

    if (orderId) poll();
  </script>
</body>
</html>
