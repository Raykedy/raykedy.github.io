<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Оплата успешна — 2051: Алгоритм Пробуждение</title>
  <meta name="color-scheme" content="dark">
  <style>
    :root{
      --bg:#0b0f14; --panel:#121824; --text:#e6f0ff;
      --muted:#a9b7d1; --stroke:#1c2533; --accent:#ff6a00;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      overflow:hidden;
    }
    .video{
      position:fixed; inset:0; z-index:-2; object-fit:cover; width:100%; height:100%;
      filter:brightness(.38) saturate(1.05);
    }
    .overlay{position:fixed; inset:0; z-index:-1;
      background:radial-gradient(1200px 600px at 50% 20%, rgba(255,106,0,.18), transparent 60%),
                 linear-gradient(180deg, transparent 0%, rgba(0,0,0,.35) 100%);
    }
    .wrap{
      min-height:100%; display:grid; place-items:center; padding:24px;
    }
    .card{
      width:min(680px, 92vw);
      background:color-mix(in srgb, var(--panel) 92%, transparent);
      border:1px solid var(--stroke);
      border-radius:18px; padding:28px 24px;
      box-shadow:0 20px 60px rgba(0,0,0,.45);
      backdrop-filter: blur(6px);
      text-align:center;
    }
    h1{margin:.2rem 0 0.6rem; font-size:clamp(22px,3.6vw,34px)}
    p{margin:.2rem 0 1rem; color:var(--muted); line-height:1.55}
    .row{display:flex; gap:12px; justify-content:center; flex-wrap:wrap; margin-top:10px}
    .btn{
      display:inline-block; padding:12px 16px; border-radius:12px;
      border:1px solid var(--stroke); text-decoration:none; color:var(--text);
      transition:.2s transform, .2s background;
      background:linear-gradient(180deg, #1d2636, #151b27);
    }
    .btn:hover{transform:translateY(-1px); background:#1b2231}
    .btn.primary{border-color:color-mix(in srgb, var(--accent) 60%, var(--stroke));
      background:linear-gradient(180deg, color-mix(in srgb, var(--accent) 35%, #1d2636),
                                         color-mix(in srgb, var(--accent) 15%, #151b27));}
    .meta{font-size:.92rem; opacity:.8}
    .ok{color:color-mix(in srgb, #00ffa2 85%, var(--text))}
    .err{color:#ff8d8d}
    footer{margin-top:12px; font-size:.85rem; color:#8ea0c2; opacity:.85}
    .logo{font-weight:700; letter-spacing:.02em}
    .small{font-size:.9rem}
  </style>
</head>
<body>
  <!-- Видеофон -->
  <video class="video" autoplay muted playsinline loop poster="обложка.jpg">
    <source src="vdhub555.mp4" type="video/mp4">
  </video>
  <div class="overlay"></div>

  <main class="wrap">
    <section class="card">
      <div class="logo small">Ray Kedy • 2051</div>
      <h1>Спасибо! Оплата получена <span class="ok">✅</span></h1>
      <p>
        Мы отправили письмо с ссылкой на <b>e-книгу (EPUB)</b> на ваш e-mail.<br>
        Также вы можете скачать книгу прямо сейчас по кнопке ниже.
      </p>

      <div class="row">
        <a id="downloadLink" class="btn primary" href="#" rel="noopener">Скачать e-книгу</a>
        <a id="resendLink" class="btn" href="#" rel="noopener">Выслать письмо ещё раз</a>
      </div>

      <p class="meta" id="status" aria-live="polite"></p>

      <footer>
        Если ссылка не открывается — проверьте «Спам» или ответьте на письмо, мы поможем.
      </footer>
    </section>
  </main>

  <script>
    // Берём orderId из ?order=...
    const q = new URLSearchParams(location.search);
    const order = q.get('order') || '';

    const statusEl = document.getElementById('status');
    const dl = document.getElementById('downloadLink');
    const resend = document.getElementById('resendLink');

    // Подтянуть временную ссылку на книгу
    fetch(`/api/order-info?order=${encodeURIComponent(order)}`)
      .then(r => r.ok ? r.json() : Promise.reject(r.status))
      .then(d => {
        if (d && d.signedUrl) {
          dl.href = d.signedUrl;
          statusEl.textContent = 'Ссылка активна 72 часа.';
        } else {
          statusEl.textContent = 'Ссылка временно недоступна. Попробуйте обновить страницу.';
          statusEl.classList.add('err');
        }
      })
      .catch(() => {
        statusEl.textContent = 'Ошибка загрузки данных. Попробуйте позже.';
        statusEl.classList.add('err');
      });

    // Повторная отправка письма (запросим у пользователя e-mail)
    resend.addEventListener('click', async (e) => {
      e.preventDefault();
      const email = prompt('Введите ваш e-mail для повторной отправки:');
      if (!email) return;
      statusEl.textContent = 'Отправляем письмо…';
      try {
        const r = await fetch('/api/resend', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ orderId: order, email })
        });
        const out = await r.json();
        statusEl.textContent = out && out.ok
          ? 'Готово! Проверьте входящие и Спам.'
          : (out.error || 'Не удалось отправить письмо.');
      } catch {
        statusEl.textContent = 'Сбой сети. Попробуйте ещё раз.';
      }
    });
  </script>
</body>
</html>
